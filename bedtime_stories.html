<html>
  <head>
    <title>Bedtime fights</title>
    <meta charset="UTF-8">
    <link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
  </head>
  <body style="background: lightgrey;">
    
    <style> 
     table {
       border-collapse: collapse;
     }
     td {
       padding: 0;
     }
     * {
       font-family: 'Architects Daughter', cursive;
     }
     .person_name{
       font-weight: bold;
     }
     
    </style>

    <div style="width:800px; margin-left: auto ;  margin-right: auto ; text-align: center;">
    <h1 style="margin-top: 2em;">Bedtime fights</h1>

    <form>
      <div style="float: left; width: 358px; height: 450px; border:1px solid grey; text-align: left; padding: 20px;">
        <p id="scene_text">&nbsp;</p>
      </div>
      <div style="width: 358px; margin-left: 400px; height: 450px; border:1px solid grey; text-align: left;  padding: 20px;">
        <div style="height: 50%; border-bottom:1px solid grey;">
          <p class="person_name" id="player_name">Me</p>
          <p id="player_text">&nbsp;</p>
        </div>
        <div style="height: 50%; ">
          <p class="person_name" id="npc_name">&nbsp;</p>
          <p id="npc_text">&nbsp;</p>
        </div>
      </div>
      <div style="width: 800px;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">

        <input type="radio" name="distance" value="closer">Get closer
        <input type="radio" name="distance" value="keep" checked="checked">Keep distance
        <input type="radio" name="distance" value="away">Get away
      </div>
    </form>
    <p>&copy; <a href="http://www.tranquilinho.com">Tranquilinho</a></p>
    </div>


    
    <script language="javascript">

     // !!!! test cases - it's not practical to do testing by hand...

     // http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513
     function getURLParameter(name) {
       return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
     }
     
     

     // !!!! refactor into its own file, bs_text.js?
     // start with a "simple DB"
     // limit text to 160 characters :-p     
     var scenes={};
     scenes["start"]=
     { english: "You are in a room with 3 guys. They all look dangerous",
       dialogs: { Joe: 0, Pete:1},
       dialog_lines:
       [
         // d00
         [{who: "me",  english: "Have you heard about that strange place?"},
          {who: "joe", english: "What place?"},
          {who: "me", english:  "That creepy old orphanage..."},
          {who: "joe", english: "Mmmm... just rumours, you know"},
          {who: "me",  english: "What kinda rumours?"},
          {who: "joe", english:  "Like, people dissapearing..."}
          ],
         // d01
         [{who: "me",  english: "Have you heard about that strange place?"},
          {who: "pete", english: "Sorry?"},
          {who: "me", english:  "That creepy old orphanage..."},
          {who: "pete", english: "Mmmm... nah"},
          {who: "me",  english: "You sure?"},
          {who: "pete", english:  "You better ask Joe..."}
          ]
       ],
       // !!!! items action
       actions:
                     [{english: "Talk", result: "talk(['Joe','Pete','Alex'])"},
                      {english: "Fight", result: "fight_tree.F001.player_health=player.health; fight(fight_tree.F001)"},
                      ],
       npcs: { Joe: { health: 10,
                      attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"},
                                {name: "Kick", hit_points: 4, description: "kicked your ass"}]},
       Pete: { health: 10,
                attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"}]},
       Alex: { health: 10,
                      attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"}]}
       }};


     var fight_tree={
        F001: { start: true, desc: "Joe is staring at you,  Pete is giving you his back while talking with Alex \
 (who is gleefully resting against the wall). Joe is big and apparently strong. It's hard to evaluate the other 2 guys" , actions: [
           {english: "Escape", result: "escape()", next: null},
           {english: "Push Pete against Alex", result: "fight(fight_tree.F002)"},
           {english: "Wait", result: "fight(fight_tree.F003)"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands'); fight(fight_tree.F004)"}]
                },     // F001
        F002: { desc: "Pete stumbled on Alex and both are stunned. Joe rushes against you furiouslly"
                , actions: [
           {english: "Run away", result: "escape()", next: null},
           {english: "Side-step defense", result: "fight(fight_tree.F006)"},
           {english: "Bring Pete and Alex to the ground", result: "fight(fight_tree.F)"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands'); fight(fight_tree.F)"}]
        },     // F002
        F003: { desc: "Joe joins Pete and Alex conversation",
                actions: [
           {english: "Escape", result: "escape()", next: null},
           {english: "Push Pete against Joe", result: null, next: "F"},
           {english: "Wait", result: null, next: "F"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands')", next: "F"}]
        },     // F003
        F004: { desc: "You try to strike hard and fast but Joe saw you coming and now is on guard. Joe is also telling \
 Pete and Alex about your intentions" , actions: [
           {english: "Run! Run!", result: "escape()", next: null},
           {english: "Kneel and beg for mercy", result: null, next: "F"},
           {english: "Go on with your plan and kick Joe's ass", result: null, next: "F"},
           {english: "Do a side sommersault and break into Pete and Alex", result:"attack('Joe','Hands')", next: "F"}]
        },     // F004
        F006: { desc: "You escaped the punch by 2 inches. Pete and Alex realized what's happening and now are facing you" , actions: [
           {english: "Give your back to Joe and run like hell", result: "fight(fight_tree.F007)"},
           {english: "Jump hard and hit hard Joe's nose with your head", result: "fight(fight_tree.F)"},
           {english: "Trip Joe", result: "fight(fight_tree.F003)"},
           {english: "Switch target to Pete and/or Alex", result:"attack('Joe','Hands'); fight(fight_tree.F)"}]
                },     // F006
        F007: { desc: "You turn fast, but before you get enough speed Joe catches you and the 3 guys merrily crack your \
ass", actions:[
           {english: "Restart fight", result: "fight(fight_tree.F001)"},
           {english: "Restart screen", result: "clean_dialogs(); assign_actions();"}]
                }     // F007       
     };

 


     function assign_actions(actions){
       if(actions[0] == undefined){
         document.forms[0].elements[0].value=" ";
         document.forms[0].elements[0].onclick=null;
       }else{
         document.forms[0].elements[0].value="1 - " + actions[0].english;
         document.forms[0].elements[0].setAttribute("onclick",actions[0].result);
       }

       if(actions[1] == undefined){
         document.forms[0].elements[1].value=" ";
         document.forms[0].elements[1].onclick=null;
       }else{    
         document.forms[0].elements[1].value="2 - " + actions[1].english;
         document.forms[0].elements[1].setAttribute("onclick",actions[1].result);
       }
     
       if(actions[2] == undefined){
         document.forms[0].elements[2].value=" ";
         document.forms[0].elements[2].onclick=null;
       }else{
         document.forms[0].elements[2].value="3 - " + actions[2].english;
         document.forms[0].elements[2].setAttribute("onclick",actions[2].result);
       }

       if(actions[3] == undefined){
         document.forms[0].elements[3].value=" ";
         document.forms[0].elements[3].onclick=null;
       }else{
         document.forms[0].elements[3].value="4 - " + actions[3].english;
         document.forms[0].elements[3].setAttribute("onclick",actions[3].result);
       }
       
     }



     function talk(whom){
       current_line=0;
       
       document.forms[0].elements[0].value="1 - Back";
       document.forms[0].elements[0].setAttribute("onclick","clean_dialogs(); assign_actions(current_scene.actions)");
       
       document.forms[0].elements[1].value="2 - Talk to " + whom[0];
       document.forms[0].elements[1].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[0]] + ")" );

       document.forms[0].elements[2].value="3 - Talk to " + whom[1];
       document.forms[0].elements[2].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[1]] + ")" );

       document.forms[0].elements[3].value="4 - Talk to " + whom[2];
       document.forms[0].elements[3].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[2]] + ")" );
       
     }

     function fight(current_node){
       if(current_node.start){
         document.getElementById("scene_text").innerHTML = "";
         player.health = current_node.player_health;
       }

       log(current_node.desc);

       show_enemy_status(["Joe", "Pete", "Alex"]);
       show_player_status();

       
       assign_actions(current_node.actions);
/*       document.forms[0].elements[0].value="1 - " + current_node.actions[0].label; - english
       document.forms[0].elements[0].setAttribute("onclick", current_node.actions[0].result); - code
       
       document.forms[0].elements[1].value="2 - " + current_node.actions[1].label;
       document.forms[0].elements[1].setAttribute("onclick", current_node.actions[1].result);

       document.forms[0].elements[2].value="3 - " + current_node.actions[2].label;
       document.forms[0].elements[2].setAttribute("onclick", current_node.actions[2].result);

       document.forms[0].elements[3].value="4 - " + current_node.actions[3].label;
       document.forms[0].elements[3].setAttribute("onclick", current_node.actions[3].result);
  */     
     }

     function fight_next(){

     }
     
     function clean_dialogs(){
       document.getElementById("npc_name").innerHTML = "&nbsp;";
       document.getElementById("npc_text").innerHTML = "&nbsp;";
       document.getElementById("player_text").innerHTML = "&nbsp;";
     }
     
     function dialog_start(dialog_number){
       if(dialog_number != current_dialog){
         current_line=0;
         document.getElementById("npc_name").innerHTML = "&nbsp;";
         document.getElementById("npc_text").innerHTML = "&nbsp;";
       }
       current_dialog=dialog_number;
       dialog_next();
     }
     
     
     function dialog_next(){
       var next_line=current_scene.dialog_lines[current_dialog][current_line];
       var speaker="me"
       var target="player_text";
       if(next_line.who != "me"){
         target="npc_text";
         speaker=next_line.who;
         document.getElementById("npc_name").innerHTML = speaker;
       }
       document.getElementById(target).innerHTML = next_line.english;
       current_line++;
     }
     
     
     function fight_start(whom){
       document.getElementById("npc_name").innerHTML = whom;

       show_enemy_status(whom);
       show_player_status();
       
       document.forms[0].elements[0].value="1 - Escape";
       document.forms[0].elements[0].setAttribute("onclick","escape()");
       
       document.forms[0].elements[1].value="2 - Defend";
       document.forms[0].elements[1].setAttribute("onclick","defend('" + whom + "')");

       document.forms[0].elements[2].value="3 - Hands Attack";
       document.forms[0].elements[2].setAttribute("onclick","attack('" + whom + "','Hands')");

       document.forms[0].elements[3].value="4 - Feet Attack";
       document.forms[0].elements[3].setAttribute("onclick","attack('" + whom + "','Feet')");
     }

     // !!!! We don't want to have to scroll, so the text should summarize or disappear before
     // growing bigger than the scene text panel...
     function log(text){
       document.getElementById("scene_text").innerHTML += "<br/>" + text;
     }

     function show_player_status(player){
       document.getElementById("player_name").innerHTML = player.name + ". " + player.health + " HP. EXP: " + player.experience;
       document.getElementById("player_text").innerHTML = player.looks + "<br>" + player.position;              
     }

     function show_enemy_status(enemies){
       var npc_text="";
       for (var i=0; i < enemies.length; i++){
         var enemy = current_scene.npcs[enemies[i]];
         if(enemy != undefined){
           npc_text += enemies[i] + " . HP: " + enemy.health + ". ";
         }
       }
       document.getElementById("npc_name").innerHTML = npc_text;       
     }

     function show_npc(npc){
       document.getElementById("npc_name").innerHTML = npc.name + ". " + npc.health + " HP. EXP: " + npc.experience;
       document.getElementById("npc_text").innerHTML = npc.looks + "<br>" + npc.position;              
     }
     
     function escape(){
       if(player.health > 0){
         log('You escaped');
         clean_dialogs();
         assign_actions(current_scene.actions);
       }
     }
     
     function attack(whom,using){
       if(player.health > 0){
         // !!!! take into account the item the player might have in the hands...
         var player_attack = player.attacks[using];
         var player_hit_points = player_attack.hit_points;

         log("You " + player_attack.description);       
         if(current_scene.npcs[whom].health >= player_hit_points){
           current_scene.npcs[whom].health -= player_hit_points;
           show_enemy_status(whom);
         }else{
           show_enemy_status(whom);           
           var npc_text = whom + " died";
           document.getElementById("npc_text").innerHTML = npc_text;
         }
       }         
       var whom_attacks = current_scene.npcs[whom].attacks; 
       var random_index=Math.floor(Math.random() * whom_attacks.length);
       var whom_attack = current_scene.npcs[whom].attacks[random_index];
       var whom_hit_points = whom_attack.hit_points;
       log(whom + " " + whom_attack.description);
       if(player.health > whom_hit_points){
         player.health -= whom_hit_points;
         show_player_status();
       }else{
         if(player.health > 0){
           player.health -= whom_hit_points;
         }
         show_player_status();
         var my_text = "You died... ";
         document.getElementById("player_text").innerHTML = my_text;
       }
     }


     function defend(from){
       if(player.health > 0){
         var from_attacks = current_scene.npcs[from].attacks; 
         var random_index=Math.floor(Math.random() * from_attacks.length);
         var from_attack = current_scene.npcs[from].attacks[random_index];
         var from_hit_points = from_attack.hit_points / 2;
         log(from + " " + from_attack.description + " but (luckily) you were on guard");
         if(player.health >= from_hit_points){
           player.health -= from_hit_points;
           show_player_status();
         }else{
           show_player_status();
           var my_text = "Your defense wasn't enough - you died... ";
           document.getElementById("player_text").innerHTML = my_text;
         }                                                            }
     }

     function fightTest(){
       fight_start("Joe");
     }

     var startTest = getURLParameter("startTest");
     if (startTest != null){
       eval(startTest+"()");
     }


     // "main()"

     var current_scene_key="start";
     var current_scene=scenes[current_scene_key];
     var current_dialog=-1;
     var current_line=0;

     var fight_actions = [
       {english: "Defend", result: "talk(['Joe','Pete','Alex'])"},
       {english: "Attack", result: "fight_tree.F001.player_health=player.health; fight(fight_tree.F001)"},
       {english: "Floor", result: ""}
     ];

     var joe={name: "Joe", looks: "Serial Killer 80%", health: 10, experience: 10, position: "middle"};
     var player={name: "Me", looks: "Inoffensive 100%", health: 8, experience: 6, position: "middle"};
     
     // document.getElementById("scene_text").innerHTML = current_scene.english;     
     assign_actions(fight_actions);
     show_player_status(player);
     show_npc(joe);
    </script>

  </body>
</html>
