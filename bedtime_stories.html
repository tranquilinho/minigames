<html>
  <head>
    <title>Bedtime fights</title>
    <meta charset="UTF-8">
    <link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
  </head>
  <body style="background: lightgrey;">
    
    <style> 
     table {
       border-collapse: collapse;
     }
     td {
       padding: 0;
     }
     * {
       font-family: 'Architects Daughter', cursive;
     }
     .person_name{
       font-weight: bold;
     }
     
    </style>

    <div style="width:800px; margin-left: auto ;  margin-right: auto ; text-align: center;">
    <h1 style="margin-top: 2em;">Bedtime fights</h1>

    <form>
      <div style="float: left; width: 358px; height: 450px; border:1px solid grey; text-align: left; padding: 20px;">
        <p id="scene_text">&nbsp;</p>
      </div>
      <div style="width: 358px; margin-left: 400px; height: 450px; border:1px solid grey; text-align: left;  padding: 20px;">
        <div style="height: 50%; border-bottom:1px solid grey;">
          <p class="person_name" id="player_name">Me</p>
          <p id="player_text">&nbsp;</p>
        </div>
        <div style="height: 50%; ">
          <p class="person_name" id="npc_name">&nbsp;</p>
          <p id="npc_text">&nbsp;</p>
        </div>
      </div>
      <div style="width: 800px;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">
        <input type="button" value="&nbsp;">

        <input type="radio" name="distance" value="closer">Get closer
        <input type="radio" name="distance" value="keep" checked="checked">Keep distance
        <input type="radio" name="distance" value="away">Get away
      </div>
    </form>
    <p>&copy; <a href="http://www.tranquilinho.com">Tranquilinho</a></p>
    </div>


    
    <script language="javascript">

     // !!!! test cases - it's not practical to do testing by hand...
     // !!!! specifically, try the different fighter combinations of player / npc (@see attack(), defend() )

     // http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513
     function getURLParameter(name) {
       return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
     }
     
     

     // !!!! refactor into its own file, bs_text.js?
     // start with a "simple DB"
     // limit text to 160 characters :-p     
     var scenes={};
     scenes["start"]=
     { english: "You are in a room with 3 guys. They all look dangerous",
       dialogs: { Joe: 0, Pete:1},
       dialog_lines:
       [
         // d00
         [{who: "me",  english: "Have you heard about that strange place?"},
          {who: "joe", english: "What place?"},
          {who: "me", english:  "That creepy old orphanage..."},
          {who: "joe", english: "Mmmm... just rumours, you know"},
          {who: "me",  english: "What kinda rumours?"},
          {who: "joe", english:  "Like, people dissapearing..."}
          ],
         // d01
         [{who: "me",  english: "Have you heard about that strange place?"},
          {who: "pete", english: "Sorry?"},
          {who: "me", english:  "That creepy old orphanage..."},
          {who: "pete", english: "Mmmm... nah"},
          {who: "me",  english: "You sure?"},
          {who: "pete", english:  "You better ask Joe..."}
          ]
       ],
       // !!!! items action
       actions:
                     [{english: "Talk", result: "talk(['Joe','Pete','Alex'])"},
                      {english: "Fight", result: "fight_tree.F001.player_health=player.health; fight(fight_tree.F001)"},
                      ],
       npcs: { Joe: { health: 10,
                      attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"},
                                {name: "Kick", hit_points: 4, description: "kicked your ass"}]},
       Pete: { health: 10,
                attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"}]},
       Alex: { health: 10,
                      attacks: [{name: "Fist", hit_points: 2, description: "punched your cheek"}]}
       }};


     var fight_tree={
        F001: { start: true, desc: "Joe is staring at you,  Pete is giving you his back while talking with Alex \
 (who is gleefully resting against the wall). Joe is big and apparently strong. It's hard to evaluate the other 2 guys" , actions: [
           {english: "Escape", result: "escape()", next: null},
           {english: "Push Pete against Alex", result: "fight(fight_tree.F002)"},
           {english: "Wait", result: "fight(fight_tree.F003)"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands'); fight(fight_tree.F004)"}]
                },     // F001
        F002: { desc: "Pete stumbled on Alex and both are stunned. Joe rushes against you furiouslly"
                , actions: [
           {english: "Run away", result: "escape()", next: null},
           {english: "Side-step defense", result: "fight(fight_tree.F006)"},
           {english: "Bring Pete and Alex to the ground", result: "fight(fight_tree.F)"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands'); fight(fight_tree.F)"}]
        },     // F002
        F003: { desc: "Joe joins Pete and Alex conversation",
                actions: [
           {english: "Escape", result: "escape()", next: null},
           {english: "Push Pete against Joe", result: null, next: "F"},
           {english: "Wait", result: null, next: "F"},
           {english: "Break Joe face in 2 halves", result:"attack('Joe','Hands')", next: "F"}]
        },     // F003
        F004: { desc: "You try to strike hard and fast but Joe saw you coming and now is on guard. Joe is also telling \
 Pete and Alex about your intentions" , actions: [
           {english: "Run! Run!", result: "escape()", next: null},
           {english: "Kneel and beg for mercy", result: null, next: "F"},
           {english: "Go on with your plan and kick Joe's ass", result: null, next: "F"},
           {english: "Do a side sommersault and break into Pete and Alex", result:"attack('Joe','Hands')", next: "F"}]
        },     // F004
        F006: { desc: "You escaped the punch by 2 inches. Pete and Alex realized what's happening and now are facing you" , actions: [
           {english: "Give your back to Joe and run like hell", result: "fight(fight_tree.F007)"},
           {english: "Jump hard and hit hard Joe's nose with your head", result: "fight(fight_tree.F)"},
           {english: "Trip Joe", result: "fight(fight_tree.F003)"},
           {english: "Switch target to Pete and/or Alex", result:"attack('Joe','Hands'); fight(fight_tree.F)"}]
                },     // F006
        F007: { desc: "You turn fast, but before you get enough speed Joe catches you and the 3 guys merrily crack your \
ass", actions:[
           {english: "Restart fight", result: "fight(fight_tree.F001)"},
           {english: "Restart screen", result: "clean_dialogs(); assign_actions();"}]
                }     // F007       
     };

 


     function assign_actions(actions){
       var button_index=0;
       for(var action_key in actions){
         var action = actions[action_key];
         if(action == undefined){
           document.forms[0].elements[button_index].value=" ";
           document.forms[0].elements[button_index].onclick=null;
         }else{
           document.forms[0].elements[button_index].value = button_index + " - " + action.english;
           document.forms[0].elements[button_index].setAttribute("onclick", action.result);
         }
         button_index ++;
       }
     }

     function assign_action(action, button_index){
         if(action == undefined){
           document.forms[0].elements[button_index].value=" ";
           document.forms[0].elements[button_index].onclick=null;
         }else{
           document.forms[0].elements[button_index].value = button_index + " - " + action.english;
           document.forms[0].elements[button_index].setAttribute("onclick", action.result);
         }
     }

     

     function talk(whom){
       current_line=0;
       
       document.forms[0].elements[0].value="1 - Back";
       document.forms[0].elements[0].setAttribute("onclick","clean_dialogs(); assign_actions(current_scene.actions)");
       
       document.forms[0].elements[1].value="2 - Talk to " + whom[0];
       document.forms[0].elements[1].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[0]] + ")" );

       document.forms[0].elements[2].value="3 - Talk to " + whom[1];
       document.forms[0].elements[2].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[1]] + ")" );

       document.forms[0].elements[3].value="4 - Talk to " + whom[2];
       document.forms[0].elements[3].setAttribute("onclick","dialog_start(" + current_scene.dialogs[whom[2]] + ")" );
       
     }

     function fight(current_node){
       if(current_node.start){
         document.getElementById("scene_text").innerHTML = "";
         player.health = current_node.player_health;
       }

       log(current_node.desc);

       show_enemy_status(["Joe", "Pete", "Alex"]);
       show_player_status();

       
       assign_actions(current_node.actions);
/*       document.forms[0].elements[0].value="1 - " + current_node.actions[0].label; - english
       document.forms[0].elements[0].setAttribute("onclick", current_node.actions[0].result); - code
       
       document.forms[0].elements[1].value="2 - " + current_node.actions[1].label;
       document.forms[0].elements[1].setAttribute("onclick", current_node.actions[1].result);

       document.forms[0].elements[2].value="3 - " + current_node.actions[2].label;
       document.forms[0].elements[2].setAttribute("onclick", current_node.actions[2].result);

       document.forms[0].elements[3].value="4 - " + current_node.actions[3].label;
       document.forms[0].elements[3].setAttribute("onclick", current_node.actions[3].result);
  */     
     }

     function fight_next(){

     }
     
     function clean_dialogs(){
       document.getElementById("npc_name").innerHTML = "&nbsp;";
       document.getElementById("npc_text").innerHTML = "&nbsp;";
       document.getElementById("player_text").innerHTML = "&nbsp;";
     }
     
     function dialog_start(dialog_number){
       if(dialog_number != current_dialog){
         current_line=0;
         document.getElementById("npc_name").innerHTML = "&nbsp;";
         document.getElementById("npc_text").innerHTML = "&nbsp;";
       }
       current_dialog=dialog_number;
       dialog_next();
     }
     
     
     function dialog_next(){
       var next_line=current_scene.dialog_lines[current_dialog][current_line];
       var speaker="me"
       var target="player_text";
       if(next_line.who != "me"){
         target="npc_text";
         speaker=next_line.who;
         document.getElementById("npc_name").innerHTML = speaker;
       }
       document.getElementById(target).innerHTML = next_line.english;
       current_line++;
     }
     
     
     function fight_start(whom){
       document.getElementById("npc_name").innerHTML = whom;

       show_enemy_status(whom);
       show_player_status();
       
       document.forms[0].elements[0].value="1 - Escape";
       document.forms[0].elements[0].setAttribute("onclick","escape()");
       
       document.forms[0].elements[1].value="2 - Defend";
       document.forms[0].elements[1].setAttribute("onclick","defend('" + whom + "')");

       document.forms[0].elements[2].value="3 - Hands Attack";
       document.forms[0].elements[2].setAttribute("onclick","attack('" + whom + "','Hands')");

       document.forms[0].elements[3].value="4 - Feet Attack";
       document.forms[0].elements[3].setAttribute("onclick","attack('" + whom + "','Feet')");
     }

     function player_movement(){
       var distance_delta = 0;
       if(document.forms[0].elements[4].checked){
         distance_delta = -0.5;
       }

       if(document.forms[0].elements[5].checked){
         distance_delta = 0;
       }

       if(document.forms[0].elements[6].checked){
         distance_delta = 0.5;
       }
       
       return distance_delta;
     }

     
     // !!!! We don't want to have to scroll, so the text should summarize or disappear before
     // growing bigger than the scene text panel...
     function log(text){
       document.getElementById("scene_text").innerHTML += "<br/>" + text;
     }

     function show_player_status(player){
       document.getElementById("player_name").innerHTML = player.name + ". " + player.health + " HP. EXP: " + player.experience;
       document.getElementById("player_text").innerHTML = player.looks + "<br>" + player.position;
       if(player.health <= 0){
         log("You died :-(");
       }
     }

     function show_enemy_status(enemies){
       var npc_text="";
       for (var i=0; i < enemies.length; i++){
         var enemy = current_scene.npcs[enemies[i]];
         if(enemy != undefined){
           npc_text += enemies[i] + " . HP: " + enemy.health + ". ";
         }
       }
       document.getElementById("npc_name").innerHTML = npc_text;       
     }

     function show_npc(npc){
       document.getElementById("npc_name").innerHTML = npc.name + ". " + npc.health + " HP. EXP: " + npc.experience;
       document.getElementById("npc_text").innerHTML = npc.looks + "<br>" + npc.position;              
     }
     
     function escape(){
       if(player.health > 0){
         log('You escaped');
         clean_dialogs();
         assign_actions(current_scene.actions);
       }
     }

     // player intention is to "attack"
     function attack(){
       if(player.health > 0){
         var enemy_base_damage = 0, player_base_damage = 0;
         
         distance += player_movement();

         if(distance < 0) distance = 0;

         // ENEMY PLAN (movement + action)
         if(enemy.attitude > 70){
           // step closer, try floor
           distance -= 0.5;
           if(distance < 0) distance = 0;
           var enemy_action = fight_actions.attack;
         }else if(enemy.attitude > 40){
           // keep distance, attack/defense
             if(enemy_last_damage == 0){
               var enemy_action = fight_actions.attack;
             }else{
               var enemy_action = fight_actions.defend;
             }
         }else if (enemy.attitude < 30 ){
           // step back, deffense
           distance += 0.5;
           var enemy_action = fight_actions.defend;           
         }


         // PLANs execution
         if(fight_actions.attack.difficulty * player.experience >= 0.3){
           enemy_base_damage = player.power;
           var fight_description = "Player attacks" + enemy.name;
           var player_failed= false;
         }else{
           var fight_description = "Player tries to attack " + enemy.name + " but fails";
           enemy_base_damage = 0;
           var player_failed = true;
         }
         
         if(enemy_action == fight_actions.attack){
           if(enemy_action.difficulty * enemy.experience >= 0.3){
             player_base_damage = enemy.power;
           }else{
             player_base_damage = 0;
           }
         }
         
         if(distance >= 1){
           // no one is hurt, no matter what :-p
           enemy_damage = 0;
           player_damage = 0;
         }else if (distance >= 0.5){
           //dodge/counter attack
           if(enemy_action == fight_actions.attack){
             enemy_damage = enemy_base_damage;
             player_damage = player_base_damage;
           }else{
             enemy_damage = 0;
             player_damage = 0;
           }
         }else{
           // block / counter attack
           if(enemy_action == fight_actions.attack){
             enemy_damage = enemy_base_damage;
             player_damage = player_base_damage;
           }else{
             enemy_damage = 0.5 * base_damage;
             player_damage = 0;             
           }
         }

         // !!!! take into account the item the player might have in the hands...

         log(fight_description + " (damage " + enemy_damage + "), enemy " + enemy_action.english + " (damage: " + player_damage + "). Distance: " + distance);            

         player.health -= player_damage;
         if (player.health <= 0){
           player.health = 0;
         }
         enemy.health -= enemy_damage;
         enemy_last_damage = enemy_damage;
         if (enemy.health <= 0){
           enemy.health = 0;
         }
         
         show_player_status(player);
         show_npc(enemy);
         
       }
     } // attack()
     

     // player intention is to "defend": stays on guard, blocks, dodges or counter-attacks
     function defend(){
        if(player.health > 0){

         distance += player_movement();
         if(distance < 0) distance = 0;
         
         // ENEMY PLAN (movement + action)
         // (apparent) HP of each fighter also influence decissions :-p
         // when deffending, the distance should tend to increase, even when the enemy gets closer
         if(enemy.attitude > 70){
           // step closer, try floor
           distance -= 0.5;
           if(distance < 0) distance = 0;
           var enemy_action = fight_actions.attack;
         }else if(enemy.attitude > 40){
           // keep distance, attack/defense
             if(enemy_last_damage == 0){
               var enemy_action = fight_actions.attack;
             }else{
               var enemy_action = fight_actions.on_guard;
             }
         }else if (enemy.attitude < 30 ){
           // step back, deffense
           distance += 0.5;
           var enemy_action = fight_actions.defend;           
         }

         // PLANs execution
         // action success depends upon effectiveness ("experience"), action difficulty
         if(enemy_action.difficulty * enemy.experience >= 0.3){
           if(enemy_action.english == "Attack"){
             // defense depends upon distance, effectiveness, HP
             if(distance >= 1){
               // on guard
               var player_reaction = "on guard";
               var player_damage = 0;               
             }else if (distance >= 0.5){
               //dodge/counter attack
               var player_reaction = "dodge";               
               var player_damage = 0;                              
             }else{
               // block / counter attack
               var player_reaction = "block";                              
               var player_damage = 0.5 * enemy.power;                              
             }
           }else if (enemy_action.english == "Floor"){

           }

           log(enemy.name + " " + enemy_action.english + " , player " + player_reaction + ", damage: " + player_damage + ". Distance: " + distance);            

           player.health -= player_damage;
           if (player.health <= 0){
             player.health = 0;
           }
           
         } // successful action
         
         show_player_status(player);
       } //player.health
     }

     function fightTest(){
       fight_start("Joe");
     }

     var startTest = getURLParameter("startTest");
     if (startTest != null){
       eval(startTest+"()");
     }


     // "main()"

     var current_scene_key="start";
     var current_scene=scenes[current_scene_key];
     var current_dialog=-1;
     var current_line=0;

     var fight_actions = {
       on_guard: {english: "On guard", result: "defend()", difficulty: 0.2},
       dodge: {english: "Dodge", result: "defend()", difficulty: 0.2},
       block: {english: "Block", result: "defend()", difficulty: 0.2},
       // by now, we consider characters always succeed when they try to defend
       defend: {english: "Defend", result: "defend()", difficulty: 0},       
       attack: {english: "Attack", result: "attack()", difficulty: 0.6},
       fail: {english: "Fail", result: "attack()", difficulty: 0.6},       
       floor: {english: "Floor", result: "floor()", difficulty: 0.8},
       // pretend you are collapsing, or show a fake attitude
       fake: {english: "Fake", result: "fake()"}
     };

     // in meters
     var distance = 1.0;
     
     // experience is a percentage, indicating how much more the character can improve
     // by now, we present it as an integer
     // attitude: 0 (run away) .. 50 (neutral) .. 100 (aggresive fury)
     // average rounds should be 3, which influences in enemies power and player defense
     var joe = {
       name: "Joe", looks: "Serial Killer 80%",
       health: 12, power: 6,
       experience: 0.5, max_experience: 100,
       position: "middle", attitude: 50};
     
     var player = {
       name: "Me", looks: "Inoffensive 100%",
       health: 9, power: 3,
       experience: 0.1, max_experience: 150,
       position: "middle", attitude: 50};
     
     // document.getElementById("scene_text").innerHTML = current_scene.english;
     log("Distance: " + distance);

     assign_action(fight_actions.defend, 0);
     assign_action(fight_actions.attack, 1);
     assign_action(fight_actions.fake, 2);
     assign_action(fight_actions.floor, 3);
     
     show_player_status(player);
     show_npc(joe);

     var enemy=joe;
     var enemy_last_damage = 0;
    </script>

  </body>
</html>
